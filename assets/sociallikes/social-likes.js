/**
 * Social Likes
 * http://sapegin.github.com/social-likes
 *
 * Sharing buttons for Russian and worldwide social networks.
 *
 * @requires jQuery
 * @author Artem Sapegin
 * @copyright 2014 Artem Sapegin (sapegin.me)
 * @license MIT
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}((function(t,e){"use strict";var i="social-likes",n=i+"__",s=i+"_opened",o="https:"===location.protocol?"https:":"http:",r="https:"===o,c={facebook:{counterUrl:"https://graph.facebook.com/fql?q=SELECT+total_count+FROM+link_stat+WHERE+url%3D%22{url}%22&callback=?",convertNumber:function(t){return t.data[0].total_count},popupUrl:"https://www.facebook.com/sharer/sharer.php?u={url}",popupWidth:600,popupHeight:500},twitter:{counterUrl:"https://cdn.api.twitter.com/1/urls/count.json?url={url}&callback=?",convertNumber:function(t){return t.count},popupUrl:"https://twitter.com/intent/tweet?url={url}&text={title}",popupWidth:600,popupHeight:450,click:function(){return/[\.\?:\-–—]\s*$/.test(this.options.title)||(this.options.title+=":"),!0}},mailru:{counterUrl:o+"//connect.mail.ru/share_count?url_list={url}&callback=1&func=?",convertNumber:function(t){for(var e in t)if(t.hasOwnProperty(e))return t[e].shares},popupUrl:o+"//connect.mail.ru/share?share_url={url}&title={title}",popupWidth:550,popupHeight:360},vkontakte:{counterUrl:"https://vk.com/share.php?act=count&url={url}&index={index}",counter:function(e,i){var n=c.vkontakte;n._||(n._=[],window.VK||(window.VK={}),window.VK.Share={count:function(t,e){n._[t].resolve(e)}});var s=n._.length;n._.push(i),t.getScript(p(e,{index:s})).fail(i.reject)},popupUrl:o+"//vk.com/share.php?url={url}&title={title}",popupWidth:550,popupHeight:330},odnoklassniki:{counterUrl:r?e:"http://connect.ok.ru/dk?st.cmd=extLike&ref={url}&uid={index}",counter:function(e,i){var n=c.odnoklassniki;n._||(n._=[],window.ODKL||(window.ODKL={}),window.ODKL.updateCount=function(t,e){n._[t].resolve(e)});var s=n._.length;n._.push(i),t.getScript(p(e,{index:s})).fail(i.reject)},popupUrl:"http://connect.ok.ru/dk?st.cmd=WidgetSharePreview&service=odnoklassniki&st.shareUrl={url}",popupWidth:550,popupHeight:360},plusone:{counterUrl:r?e:"http://share.yandex.ru/gpp.xml?url={url}",counter:function(e,i){var n=c.plusone;n._?i.reject():(window.services||(window.services={}),window.services.gplus={cb:function(t){"string"==typeof t&&(t=t.replace(/\D/g,"")),n._.resolve(parseInt(t,10))}},n._=i,t.getScript(p(e)).fail(i.reject))},popupUrl:"https://plus.google.com/share?url={url}",popupWidth:700,popupHeight:500},pinterest:{counterUrl:o+"//api.pinterest.com/v1/urls/count.json?url={url}&callback=?",convertNumber:function(t){return t.count},popupUrl:o+"//pinterest.com/pin/create/button/?url={url}&description={title}",popupWidth:630,popupHeight:270}},u={promises:{},fetch:function(e,i,n){u.promises[e]||(u.promises[e]={});var s=u.promises[e];if(!n.forceUpdate&&s[i])return s[i];var o=t.extend({},c[e],n),r=t.Deferred(),a=o.counterUrl&&p(o.counterUrl,{url:i});return a&&t.isFunction(o.counter)?o.counter(a,r):o.counterUrl?t.getJSON(a).done((function(e){try{var i=e;t.isFunction(o.convertNumber)&&(i=o.convertNumber(e)),r.resolve(i)}catch(t){r.reject()}})).fail(r.reject):r.reject(),s[i]=r.promise(),s[i]}};function a(t,e){this.container=t,this.options=e,this.init()}function l(e,i){this.widget=e,this.options=t.extend({},i),this.detectService(),this.service&&this.init()}function p(t,e){return h(t,e,encodeURIComponent)}function h(t,e,i){return t.replace(/\{([^\}]+)\}/g,(function(t,n){return n in e?i?i(e[n]):e[n]:t}))}function d(t,e){var i=n+t;return i+" "+i+"_"+e}t.fn.socialLikes=function(e){return this.each((function(){var n=t(this),s=n.data(i);s?t.isPlainObject(e)&&s.update(e):(s=new a(n,t.extend({},t.fn.socialLikes.defaults,e,function(t){function e(t,e){return e.toUpper()}var i={},n=t.data();for(var s in n){var o=n[s];"yes"===o?o=!0:"no"===o&&(o=!1),i[s.replace(/-(\w)/g,e)]=o}return i}(n))),n.data(i,s))}))},t.fn.socialLikes.defaults={url:window.location.href.replace(window.location.hash,""),title:document.title,counters:!0,zeroes:!1,wait:500,timeout:1e4,popupCheckInterval:500,singleTitle:"Share",initHtml:!0},a.prototype={init:function(){this.container.addClass(i),this.single=this.container.hasClass(i+"_single"),this.initUserButtons(),this.countersLeft=0,this.number=0,this.container.on("counter."+i,t.proxy(this.updateCounter,this));var e=this.container.children();this.makeSingleButton(),this.buttons=[],e.each(t.proxy((function(e,i){var n=new l(t(i),this.options);this.buttons.push(n),n.options.counterUrl&&this.countersLeft++}),this)),this.options.counters?(this.timer=setTimeout(t.proxy(this.appear,this),this.options.wait),this.timeout=setTimeout(t.proxy(this.ready,this,!0),this.options.timeout)):this.appear()},initUserButtons:function(){!this.userButtonInited&&window.socialLikesButtons&&t.extend(!0,c,socialLikesButtons),this.userButtonInited=!0},makeSingleButton:function(){if(this.single){var e=this.container;e.addClass(i+"_vertical"),e.wrap(t("<div>",{class:i+"_single-w"})),e.wrapInner(t("<div>",{class:i+"__single-container"}));var n=e.parent(),o=t("<div>",{class:d("widget","single")}),r=t(h('<div class="{buttonCls}"><span class="{iconCls}"></span>{title}</div>',{buttonCls:d("button","single"),iconCls:d("icon","single"),title:this.options.singleTitle}));o.append(r),n.append(o),o.on("click",(function(){var n=i+"__widget_active";return o.toggleClass(n),o.hasClass(n)?(e.css({left:-(e.width()-o.width())/2,top:-e.height()}),function(t){var e=10;if(document.documentElement.getBoundingClientRect){var i=parseInt(t.css("left"),10),n=parseInt(t.css("top"),10),o=t[0].getBoundingClientRect();o.left<e?t.css("left",e-o.left+i):o.right>window.innerWidth-e&&t.css("left",window.innerWidth-o.right-e+i),o.top<e?t.css("top",e-o.top+n):o.bottom>window.innerHeight-e&&t.css("top",window.innerHeight-o.bottom-e+n)}t.addClass(s)}(e),function(e,i){function n(c){"keydown"===c.type&&27!==c.which||t(c.target).closest(e).length||(e.removeClass(s),o.off(r,n),t.isFunction(i)&&i())}var o=t(document),r="click touchstart keydown";o.on(r,n)}(e,(function(){o.removeClass(n)}))):e.removeClass(s),!1})),this.widget=o}},update:function(e){if(e.forceUpdate||e.url!==this.options.url){this.number=0,this.countersLeft=this.buttons.length,this.widget&&this.widget.find("."+i+"__counter").remove(),t.extend(this.options,e);for(var n=0;n<this.buttons.length;n++)this.buttons[n].update(e)}},updateCounter:function(t,e,i){i&&(this.number+=i,this.single&&this.getCounterElem().text(this.number)),this.countersLeft--,0===this.countersLeft&&(this.appear(),this.ready())},appear:function(){this.container.addClass(i+"_visible")},ready:function(t){this.timeout&&clearTimeout(this.timeout),this.container.addClass(i+"_ready"),t||this.container.trigger("ready."+i,this.number)},getCounterElem:function(){var e=this.widget.find(".social-likes__counter_single");return e.length||(e=t("<span>",{class:d("counter","single")}),this.widget.append(e)),e}},l.prototype={init:function(){this.detectParams(),this.options.initHtml?this.initHtml():this.widget.on("click",t.proxy(this.click,this)),setTimeout(t.proxy(this.initCounter,this),0)},update:function(e){t.extend(this.options,{forceUpdate:!1},e),this.widget.find("."+i+"__counter").remove(),this.initCounter()},detectService:function(){var e=this.widget.data("service");if(!e){for(var i=this.widget[0],n=i.classList||i.className.split(" "),s=0;s<n.length;s++){var o=n[s];if(c[o]){e=o;break}}if(!e)return}this.service=e,t.extend(this.options,c[e])},detectParams:function(){var t=this.widget.data();if(t.counter){var e=parseInt(t.counter,10);isNaN(e)?this.options.counterUrl=t.counter:this.options.counterNumber=e}t.title&&(this.options.title=t.title),t.url&&(this.options.url=t.url)},initHtml:function(){var e=this.options,i=this.widget,n=i.find("a");n.length&&this.cloneDataAttrs(n,i);var s=t("<span>",{class:this.getElementClassNames("button"),text:i.text()});if(e.clickUrl){var o=p(e.clickUrl,{url:e.url,title:e.title}),r=t("<a>",{href:o});this.cloneDataAttrs(i,r),i.replaceWith(r),this.widget=i=r}else i.on("click",t.proxy(this.click,this));i.removeClass(this.service),i.addClass(this.getElementClassNames("widget")),s.prepend(t("<span>",{class:this.getElementClassNames("icon")})),i.empty().append(s),this.button=s},initCounter:function(){if(this.options.counters)if(this.options.counterNumber)this.updateCounter(this.options.counterNumber);else{var e={counterUrl:this.options.counterUrl,forceUpdate:this.options.forceUpdate};u.fetch(this.service,this.options.url,e).always(t.proxy(this.updateCounter,this))}},cloneDataAttrs:function(t,e){var i=t.data();for(var n in i)i.hasOwnProperty(n)&&e.data(n,i[n])},getElementClassNames:function(t){return d(t,this.service)},updateCounter:function(e){e=parseInt(e,10)||0;var n={class:this.getElementClassNames("counter"),text:e};e||this.options.zeroes||(n.class+=" "+i+"__counter_empty",n.text="");var s=t("<span>",n);this.widget.append(s),this.widget.trigger("counter."+i,[this.service,e])},click:function(e){var i=this.options,n=!0;if(t.isFunction(i.click)&&(n=i.click.call(this,e)),n){var s=p(i.popupUrl,{url:i.url,title:i.title});s=this.addAdditionalParamsToUrl(s),this.openPopup(s,{width:i.popupWidth,height:i.popupHeight})}return!1},addAdditionalParamsToUrl:function(e){var i=t.param(t.extend(this.widget.data(),this.options.data));if(t.isEmptyObject(i))return e;var n=-1===e.indexOf("?")?"?":"&";return e+n+i},openPopup:function(e,n){var s=Math.round(screen.width/2-n.width/2),o=0;screen.height>n.height&&(o=Math.round(screen.height/3-n.height/2));var r=window.open(e,"sl_"+this.service,"left="+s+",top="+o+",width="+n.width+",height="+n.height+",personalbar=0,toolbar=0,scrollbars=1,resizable=1");if(r){r.focus(),this.widget.trigger("popup_opened."+i,[this.service,r]);var c=setInterval(t.proxy((function(){r.closed&&(clearInterval(c),this.widget.trigger("popup_closed."+i,this.service))}),this),this.options.popupCheckInterval)}else location.href=e}},t((function(){t("."+i).socialLikes()}))}));